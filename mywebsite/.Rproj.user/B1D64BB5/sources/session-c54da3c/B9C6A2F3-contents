---
title: "Preparation for Final Analysis"
author: "Ye Zhang"
date: "2024-09-10"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This document includes the preparation work for final data analysis:  

- Sample firms and their covariates  
- Treatment variable: Party cell adoption  
- Outcome variable: Party language, party members in board, donation  
- Preliminary analysis

# Sample firms

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(readxl)
library(readtext)
library(openxlsx)
library(haven)
library(ggplot2)
library(stargazer)
library(viridis)
library(egg)
library(gridExtra)
library(purrr)
library(knitr)
library(fixest)
library(panelView)
library(PanelMatch)
library(paneltools)
library(fixest)
library(did)
# always-private firms in 2012
d <- readRDS("/Users/yezhang/Dropbox (MIT)/Dissertation/Data/sample_firm_since_2012_checked.rds")

# add leading zeros to firm id
firms <- d %>% 
  mutate(firm_id_full = str_pad(firm_id, 6, pad = "0")) %>%
  select(-firm_id) %>%
  select(firm_id = firm_id_full, pc_est_year, pc_app_year)

# construct panel data
firms_p <- expand_grid(unique(firms$firm_id), 2012:2020)

names(firms_p) <- c("firm_id", "year")

firms_p <- firms_p %>% 
  left_join(firms, by = "firm_id") %>% 
  mutate(pc_est = ifelse(is.na(pc_est_year) | year < pc_est_year, 0, 1),
         pc_app = ifelse(is.na(pc_app_year) | year < pc_app_year, 0, 1))

# plot trend
aa <- firms_p %>% group_by(year) %>%
  summarize(adopt = sum(pc_app),
            pct_adopt = sum(pc_app)/n())

ggplot(aa, aes(x = year, y = pct_adopt)) +
  geom_col(position = position_dodge()) +
  #geom_text(aes(label = scales::percent(round(pct_adopt, 3))), 
  #          position = position_dodge(0.9), vjust = -0.5) +
  scale_y_continuous(labels = scales::percent) +
  labs(
       #title = "Party cells are increasing",
       #subtitle = "By first mention in corporate charters",
       x = "Year",
       y = "Percent of Firms") +
       #caption = "Source: CNINFO") +
  theme_bw() +
  theme(#plot.title = element_text(hjust = 0.5), 
    axis.text.x=element_text(size=15),
    text = element_text(size=15))




# add firm covariates
csmar <- read_dta("/Users/yezhang/Dropbox (MIT)/Dissertation/Data/GTALC2020/GTA2020final.dta")

covs <- csmar %>% 
  filter(id_org %in% firms$firm_id) %>%
  filter(year >= 2012 & year <= 2020) %>% #csmar only have data to 2020
  select(firm_id = id_org, year,
         industry = Sicmen_str, 
         est_year = Estbyear, 
         list_year = Listyear,
         prov_reg, city_reg, county_reg, 
         prov_off, city_off, county_off, 
         reg_cap = RegisterCapital,
         n_worker = Empnum4,
         fix_asset = A001212000,
         fix_asset_pct = F030801A,
         roa, roe,
         out_share = Nshrn,
         close_price = Yclsprc) %>% 
  mutate(firm_age = year - est_year, 
         mar_cap = out_share*close_price) # market capitalization as a better measure of firm size

industry_names <- read_excel("/Users/yezhang/Dropbox (MIT)/Dissertation/Data/industry_code_one_digit.xlsx")

covs <- covs %>% 
  left_join(industry_names, by = c("industry" = "industry_code"))

firms_p <- firms_p %>% left_join(covs, by = c("firm_id", "year"))
```

# TWFE (effect of PC on firm ROA)

```{r}
firms_p$firm_id <- as.integer(firms_p$firm_id)
firms_p$year <- as.integer(firms_p$year)
firms_p <- as.data.frame(firms_p)

# use two-way fixed effects
model.twfe.0 <- feols(roa ~ pc_app | firm_id + year,
                      data = firms_p, cluster = "firm_id")

print(model.twfe.0)

# drop always treated units
df <- as.data.frame(firms_p %>% group_by(firm_id) %>% mutate(treatment_mean = mean(pc_app, na.rm = TRUE)))
df.use <- df[which(df$treatment_mean < 1), ]

# Re-estimate TWFE on this Sub-sample
model.twfe.1 <- feols(roa ~ pc_app | firm_id + year,
                      data = df.use, cluster = "firm_id")
print(model.twfe.1)

df.use <- get.cohort(df.use, D = "pc_app", index = c("firm_id", "year"))

df.twfe <- df.use
df.twfe$treat <- as.numeric(df.twfe$treatment_mean>0) # drop always treated units
df.twfe[which(is.na(df.twfe$Time_to_Treatment)),'Time_to_Treatment'] <- 0 # can be an arbitrary value
twfe.est <- feols(roa ~ i(Time_to_Treatment, treat, ref = -1)| firm_id + year,  
                  data = df.twfe, cluster = "firm_id")
twfe.output <- as.matrix(twfe.est$coeftable)
print(twfe.output) 

twfe.output <- as.data.frame(twfe.output)
twfe.output$Time <- c(c(-7:-2),c(0:8))+1 # change

p.twfe <- esplot(twfe.output,Period = 'Time',Estimate = 'Estimate',
                 SE = 'Std. Error', xlim = c(-10,10))
```

# TWFE (effect of PC on party language)

```{r}
# read in data
reports <- readRDS("/Users/yezhang/Dropbox (MIT)/Dissertation/Data/CNINF/reports_final.rds")
reports$date <- as.Date(reports$date)
reports$year <- as.integer(reports$year)

# clean data  
reports <- reports %>%
  filter(!str_detect(doc_id, "取消")) %>%
  filter(!str_detect(doc_id, "英文")) %>%
  separate(doc_id, into = c("id", "doc_title"), sep = "-") %>%
  mutate(year_doc = as.integer(str_extract(doc_title, "20\\d{2}"))) %>%
  select(firm_id, year = year_doc, doc_title, date_pub = date, n_char, n_party)

# remove reports that are too short (补充/更正公告)
# only keep one report per year (with the latest publication time)
reports <- reports %>% 
  filter(n_char > 50000) %>%
  group_by(firm_id, year) %>% 
  top_n(1, date_pub)

reports <- reports %>% 
  group_by(firm_id, year) %>% 
  top_n(1, n_char)

firms_p <- firms_p %>% left_join(reports, by = c("firm_id", "year"))
```

```{r}
firms_p$firm_id <- as.integer(firms_p$firm_id)
firms_p$year <- as.integer(firms_p$year)
firms_p <- as.data.frame(firms_p)

firms_p <- firms_p %>% mutate(pct_party = n_party/n_char)

# use two-way fixed effects
model.twfe.0 <- feols(n_party ~ pc_app | firm_id + year,
                      data = firms_p, cluster = "firm_id")

print(model.twfe.0)

# drop always treated units
df <- as.data.frame(firms_p %>% group_by(firm_id) %>% mutate(treatment_mean = mean(pc_app, na.rm = TRUE)))
df.use <- df[which(df$treatment_mean < 1), ]

# Re-estimate TWFE on this Sub-sample
model.twfe.1 <- feols(n_party ~ pc_app | firm_id + year,
                      data = df.use, cluster = "firm_id")
print(model.twfe.1)

df.use <- get.cohort(df.use, D = "pc_app", index = c("firm_id", "year"))

df.twfe <- df.use
df.twfe$treat <- as.numeric(df.twfe$treatment_mean>0) # drop always treated units
df.twfe[which(is.na(df.twfe$Time_to_Treatment)),'Time_to_Treatment'] <- 0 # can be an arbitrary value
twfe.est <- feols(n_party ~ i(Time_to_Treatment, treat, ref = -1)| firm_id + year,  
                  data = df.twfe, cluster = "firm_id")
twfe.output <- as.matrix(twfe.est$coeftable)
print(twfe.output) 

twfe.output <- as.data.frame(twfe.output)
twfe.output$Time <- c(c(-7:-2),c(0:8))+1 # change

p.twfe <- esplot(twfe.output,Period = 'Time',Estimate = 'Estimate',
                 SE = 'Std. Error', xlim = c(-10,10))
```

# only keep firms with exact timing

```{r}
firms_p_sub <- firms_p %>% filter(!is.na(firms_p$pc_est_year))
  
model.twfe.0 <- feols(pct_party ~ pc_app | firm_id + year,
                      data = firms_p_sub, cluster = "firm_id")

print(model.twfe.0)
```

# add covariates

```{r}
model.twfe.0 <- feols(pct_party ~ pc_app*prov_reg | firm_id + year,
                      data = firms_p, cluster = "firm_id")

summary(model.twfe.0)
```

# CS DiD

```{r}
df.cs <- df.use
df.cs[which(is.na(df.cs$FirstTreat)),"FirstTreat"] <- 0 # replace NA with 0
cs.est.1 <- att_gt(yname = "n_party",
                 gname = "FirstTreat",
                 idname = "firm_id",
                 tname = "year",
                 xformla = ~1,
                 control_group = "nevertreated",
                 allow_unbalanced_panel = TRUE,
                 data = df.cs,
                 est_method = "reg")
cs.est.att.1 <- aggte(cs.est.1, type = "simple", na.rm=T, bstrap = F)
print(cs.est.att.1)
```

https://yiqingxu.org/tutorials/panel.html#PanelMatch



